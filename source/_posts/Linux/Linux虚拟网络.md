---
title: linux虚拟网络
date: 2018-07-19 12:12:28
tags:
- Linux
---


### 1. tun/tap

- 图示

```bash
+----------------------------------------------------------------+
|                                                                |
|  +--------------------+      +--------------------+            |
|  | User Application A |      | User Application B |<-----+     |
|  +--------------------+      +--------------------+      |     |
|               | 1                    | 5                 |     |
|...............|......................|...................|.....|
|               ↓                      ↓                   |     |
|         +----------+           +----------+              |     |
|         | socket A |           | socket B |              |     |
|         +----------+           +----------+              |     |
|                 | 2               | 6                    |     |
|.................|.................|......................|.....|
|                 ↓                 ↓                      |     |
|             +------------------------+                 4 |     |
|             | Newwork Protocol Stack |                   |     |
|             +------------------------+                   |     |
|                | 7                 | 3                   |     |
|................|...................|.....................|.....|
|                ↓                   ↓                     |     |
|        +----------------+    +----------------+          |     |
|        |      eth0      |    |      tun0      |          |     |
|        +----------------+    +----------------+          |     |
|    10.32.0.11  |                   |   192.168.3.11      |     |
|                | 8                 +---------------------+     |
|                |                                               |
+----------------|-----------------------------------------------+
                 ↓
         Physical Network
```
<!--more-->

**tun一段连着协议栈，另一端连接应用程序**

>tun设备只能读写IP数据包，而通过tap设备能读写链路层数据包

### 2. veth

- veth和其它的网络设备都一样，一端连接的是内核协议栈。

- veth设备是成对出现的，另一端两个设备彼此相连

- 一个设备收到协议栈的数据发送请求后，会将数据发送到另一个设备上去

```bash
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|              ↑               ↑               ↑                 |
|..............|...............|...............|.................|
|              ↓               ↓               ↓                 |
|        +----------+    +-----------+   +-----------+           |
|        |   eth0   |    |   veth0   |   |   veth1   |           |
|        +----------+    +-----------+   +-----------+           |
|192.168.1.11  ↑               ↑               ↑                 |
|              |               +---------------+                 |
|              |         192.168.2.11     192.168.2.1            |
+--------------|-------------------------------------------------+
               ↓
         Physical Network
```

#### 2.1 操作

- 添加

```bash
#创建，成对创建
ip link add veth0 type veth peer name veth1
#为veth0配置IP
ip addr add 192.168.2.11/24 dev veth0
ip addr add 192.168.2.1/24 dev veth1
#分别启动veth0和veth1
ip link set veth0 up
ip link set veth1 up
```
**从veth0设备出去的数据包，会转发到veth1上，如果目的地址是veth1的IP的话，就能被协议栈处理，否则连ARP那关都过不了**

### 3. 网桥

网桥既是一个虚拟网络设备，也是一个虚拟交换机

网桥有多个接口，从一个口进来，可以从另外的口出去

#### 3.1 网桥使用

- 创建网桥

```bash
#创建网桥
ip link add name br0 type bridge
#启动网桥
ip link set br0 up

```

此时的网桥就是个虚拟的网络设备，只有一个端口连着内核中的协议栈，没有实际的功能

```bash
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|              ↑                                ↑                |
|..............|................................|................|
|              ↓                                ↓                |
|        +----------+                     +------------+         |
|        |   eth0   |                     |     br0    |         |
|        +----------+                     +------------+         |
| 192.168.3.21 ↑                                                 |
|              |                                                 |
|              |                                                 |
+--------------|-------------------------------------------------+
               ↓
         Physical Network
```

- br与veth相连接

```bash
#创建一对veth设备并且配置上IP
ip link add veth0 type veth peer name veth1
#配置IP
ip addr add 192.168.3.101/24 dev veth0
ip addr add 192.168.3.102/24 dev veth1
#启动他们
ip link set veth0 up
ip link set veth1 up

#网桥br0连接上veth
ip link set dev veth0 master br0
#查看已经存在的连接
bridge link
#查看已经创建的网桥


```

此时的拓扑图是这样的

```bash
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|            ↑            ↑              |            ↑          |
|............|............|..............|............|..........|
|            ↓            ↓              ↓            ↓          |
|        +------+     +--------+     +-------+    +-------+      |
|        | .3.21|     |        |     | .3.101|    | .3.102|      |
|        +------+     +--------+     +-------+    +-------+      |
|        | eth0 |     |   br0  |<--->| veth0 |    | veth1 |      |
|        +------+     +--------+     +-------+    +-------+      |
|            ↑                           ↑            ↑          |
|            |                           |            |          |
|            |                           +------------+          |
|            |                                                   |
+------------|---------------------------------------------------+
             ↓
     Physical Network
```

此时，

 br0和veth0之间连接起来了，并且是双向的通道


协议栈和veth0之间变成了单通道，协议栈能发数据给veth0
也就是说，veth0和veth1无法互通，veth0无法发送数据包给协议栈，而是给了br0

br0的mac就变为veth0的mac

veth0向协议栈发送的数据包将会被br0拦截

- 给br0配置IP

可见veth0上的IP是没有意义的，现在把veth0上的IP转移给br0

```bash
#删掉veth0上的IP
ip addr del 192.168.3.101/24 dev veth0
#配置网桥br0上的IP
ip addr add 192.168.3.101/24 dev br0
```

此时就是这样的

```bash
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|            ↑            ↑                           ↑          |
|............|............|...........................|..........|
|            ↓            ↓                           ↓          |
|        +------+     +--------+     +-------+    +-------+      |
|        | .3.21|     | .3.101 |     |       |    | .3.102|      |
|        +------+     +--------+     +-------+    +-------+      |
|        | eth0 |     |   br0  |<--->| veth0 |    | veth1 |      |
|        +------+     +--------+     +-------+    +-------+      |
|            ↑                           ↑            ↑          |
|            |                           |            |          |
|            |                           +------------+          |
|            |                                                   |
+------------|---------------------------------------------------+
             ↓
     Physical Network
```

此时可以从br0 ping 通veth1，但是ping不通网关，

因为br0上面仅仅有101和103，没有1的网关地址

- 把外网网卡eth0接入网桥

```bash
ip link set dev eth0 master br0
bridge link
```

这样以来，从外面网络收到的数据包通过eth0将无条件的转发给br0，eth0将不会再给内核协议栈

br0两端的网络设备无论是实体还是虚拟都是br0的网线

此时就是这样的

```bash
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|                         ↑                           ↑          |
|.........................|...........................|..........|
|                         ↓                           ↓          |
|        +------+     +--------+     +-------+    +-------+      |
|        |      |     | .3.101 |     |       |    | .3.102|      |
|        +------+     +--------+     +-------+    +-------+      |
|        | eth0 |<--->|   br0  |<--->| veth0 |    | veth1 |      |
|        +------+     +--------+     +-------+    +-------+      |
|            ↑                           ↑            ↑          |
|            |                           |            |          |
|            |                           +------------+          |
|            |                                                   |
+------------|---------------------------------------------------+
             ↓
     Physical Network
```

- stp协议

stp Spanning Tree Protocol

在二层交换机中，越来越多的交换机会形成物理**环路**

![071733737](https://qiniu.li-rui.top/071733737.jpg)

pc1和pc2通讯的过程中，pc1会发送arp请求给sw1

sw1接收到pc1的广播后，根据交换机工作原理他会向所有的非接收端口广播

当SW2和SW3收到广播后，同样也会广播此广播包

**ok 形成了环路了**

stp协议就是在上面环路上进行阻断一些端口

首先 选择根网桥，bridge id小的为根网桥，id一样的mac地址小的为跟网桥

起次 选择跟端口 根路径成本低的为根端口

最后选择指定端口 将到达根网桥最近的端口

对某一个网桥开启stp

```bash
brctl stp br0 on
```

- 添加网桥的正确姿势

```bash
ip link add name br-wan type bridge
ip link set br-wan up
ip addr add 192.168.12.68/24 dev br-wan
ip link set dev eth2 master br-wan
ip route del default via 192.168.12.1 dev eth2
ip route add default via 192.168.12.1 dev br-wan

ping 172.18.10.1 -c 3 > /dev/null

if $? -ne 0; then

    #del br-wan
	ip link delete br-wan type bridge
  	ip route add default via 192.168.12.1 dev eth2
	
	#reserve br-wan
	#ip link set eth2 nomaster
	#ip addr del 192.168.12.68/24 dev br-wan
	#ip route add default via 192.168.12.1 dev eth2
	
fi
```

#### 3.2 两种使用场景

- 虚拟机

虚拟机不需要进入宿主机内核协议栈

```bash
+----------------------------------------------------------------+-----------------------------------------+-----------------------------------------+
|                          Host                                  |              VirtualMachine1            |              VirtualMachine2            |
|                                                                |                                         |                                         |
|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |
|       |             Newwork Protocol Stack             |       |       |  Newwork Protocol Stack |       |       |  Newwork Protocol Stack |       |
|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |
|                          ↑                                     |                   ↑                     |                    ↑                    |
|..........................|.....................................|...................|.....................|....................|....................|
|                          ↓                                     |                   ↓                     |                    ↓                    |
|                     +--------+                                 |               +-------+                 |                +-------+                |
|                     | .3.101 |                                 |               | .3.102|                 |                | .3.103|                |
|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |
|        | eth0 |<--->|   br0  |<--->|tun/tap|                   |               | eth0  |                 |                | eth0  |                |
|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |
|            ↑             ↑             ↑                       |                   ↑                     |                    ↑                    |
|            |             |             +-------------------------------------------+                     |                    |                    |
|            |             ↓                                     |                                         |                    |                    |
|            |         +-------+                                 |                                         |                    |                    |
|            |         |tun/tap|                                 |                                         |                    |                    |
|            |         +-------+                                 |                                         |                    |                    |
|            |             ↑                                     |                                         |                    |                    |
|            |             +-------------------------------------------------------------------------------|--------------------+                    |
|            |                                                   |                                         |                                         |
|            |                                                   |                                         |                                         |
|            |                                                   |                                         |                                         |
+------------|---------------------------------------------------+-----------------------------------------+-----------------------------------------+
             ↓
     Physical Network  (192.168.3.0/24)

```

- docker

docker需要进入内核协议栈做一下nat转换

```bash
+----------------------------------------------------------------+-----------------------------------------+-----------------------------------------+
|                          Host                                  |              Container 1                |              Container 2                |
|                                                                |                                         |                                         |
|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |
|       |             Newwork Protocol Stack             |       |       |  Newwork Protocol Stack |       |       |  Newwork Protocol Stack |       |
|       +------------------------------------------------+       |       +-------------------------+       |       +-------------------------+       |
|            ↑             ↑                                     |                   ↑                     |                    ↑                    |
|............|.............|.....................................|...................|.....................|....................|....................|
|            ↓             ↓                                     |                   ↓                     |                    ↓                    |
|        +------+     +--------+                                 |               +-------+                 |                +-------+                |
|        |.3.101|     |  .9.1  |                                 |               |  .9.2 |                 |                |  .9.3 |                |
|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |
|        | eth0 |     |   br0  |<--->|  veth |                   |               | eth0  |                 |                | eth0  |                |
|        +------+     +--------+     +-------+                   |               +-------+                 |                +-------+                |
|            ↑             ↑             ↑                       |                   ↑                     |                    ↑                    |
|            |             |             +-------------------------------------------+                     |                    |                    |
|            |             ↓                                     |                                         |                    |                    |
|            |         +-------+                                 |                                         |                    |                    |
|            |         |  veth |                                 |                                         |                    |                    |
|            |         +-------+                                 |                                         |                    |                    |
|            |             ↑                                     |                                         |                    |                    |
|            |             +-------------------------------------------------------------------------------|--------------------+                    |
|            |                                                   |                                         |                                         |
|            |                                                   |                                         |                                         |
|            |                                                   |                                         |                                         |
+------------|---------------------------------------------------+-----------------------------------------+-----------------------------------------+
             ↓
     Physical Network  (192.168.3.0/24)
```
